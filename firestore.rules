rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    // ตรวจสอบว่า login แล้ว
    function isAuthenticated() {
      return request.auth != null;
    }

    // ตรวจสอบว่าเป็นเจ้าของ
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ตรวจสอบว่าเป็น admin
    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super-admin'];
    }

    // ตรวจสอบว่าเป็น super-admin
    function isSuperAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
    }

    // ============================================
    // Users Collection
    // - Relational Model: เก็บเฉพาะ UID
    // - ข้อมูล user ทั้งหมดอยู่ที่นี่ (Single Source of Truth)
    // - Fields: displayName, slug, aboutMe, photoURL, photoURLThumb, role, isPremium
    // ============================================
    match /users/{userId} {
      // อ่านได้ทุกคน (สำหรับดู profile และ fetch user data แบบ dynamic)
      allow read: if true;

      // สร้างได้เมื่อ login และ userId ตรงกับ auth.uid
      allow create: if isOwner(userId);

      // แก้ไขได้เฉพาะเจ้าของ (ผ่าน API เป็นหลัก)
      // Admin SDK bypass rules อยู่แล้ว
      allow update: if isOwner(userId);

      // ลบได้เฉพาะ super-admin (ผ่าน Admin SDK)
      allow delete: if false;
    }

    // ============================================
    // Story Posts Collection (เรื่องราวชีวิต)
    // - Relational: เก็บเฉพาะ userId (ไม่เก็บ authorName, authorPhoto)
    // - ใช้ API + Admin SDK เป็นหลัก
    // ============================================
    match /storyPosts/{postId} {
      // อ่านได้ถ้า public หรือเป็นเจ้าของ
      allow read: if resource.data.visibility == 'public'
                  || isOwner(resource.data.userId);

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // Vent Posts Collection (ระบายความรู้สึก)
    // - Relational: เก็บเฉพาะ authorId (ไม่เก็บ authorName, authorPhoto)
    // - ใช้ API + Admin SDK เป็นหลัก
    // ============================================
    match /ventPosts/{postId} {
      // อ่านได้ทุกคน (anonymous posts)
      allow read: if true;

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;

      // Subcollection: Comments
      match /comments/{commentId} {
        // อ่านได้ทุกคน
        allow read: if true;

        // เขียนผ่าน API เท่านั้น (Admin SDK)
        allow create, update, delete: if false;
      }
    }

    // ============================================
    // Comments Collection (standalone)
    // - Relational: เก็บเฉพาะ userId (ไม่เก็บ authorName, authorPhoto)
    // ============================================
    match /comments/{commentId} {
      // อ่านได้ทุกคน
      allow read: if true;

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // Emotions/Reactions Collection
    // - Relational: เก็บเฉพาะ userId
    // ============================================
    match /emotions/{emotionId} {
      // อ่านได้ทุกคน
      allow read: if true;

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // Friends Collection
    // - Relational: เก็บเฉพาะ userId + friendId
    // - ไม่เก็บ displayName, photoURL
    // ============================================
    match /friends/{friendshipId} {
      // อ่านได้เฉพาะคนที่เกี่ยวข้อง
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.friendId == request.auth.uid);

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // Friend Requests Collection
    // - Relational: เก็บเฉพาะ senderId + receiverId
    // - ไม่เก็บ senderName, senderPhoto, receiverName
    // ============================================
    match /friendRequests/{requestId} {
      // อ่านได้เฉพาะผู้ส่งหรือผู้รับ
      allow read: if isAuthenticated() &&
                  (resource.data.senderId == request.auth.uid ||
                   resource.data.receiverId == request.auth.uid);

      // เขียนผ่าน API เท่านั้น (Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // Notifications Collection
    // - Relational: เก็บเฉพาะ userId + senderId
    // - ไม่เก็บ senderName, senderPhoto
    // ============================================
    match /notifications/{notificationId} {
      // อ่านได้เฉพาะเจ้าของ
      allow read: if isOwner(resource.data.userId);

      // แก้ไข read status ได้ (mark as read)
      allow update: if isOwner(resource.data.userId) &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);

      // สร้าง/ลบ ผ่าน API เท่านั้น (Admin SDK)
      allow create, delete: if false;
    }

    // ============================================
    // User Consents Collection (PDPA)
    // - เก็บ consent records 5 ปี
    // ============================================
    match /userConsents/{consentId} {
      // อ่านได้เฉพาะเจ้าของ
      allow read: if isOwner(resource.data.userId);

      // สร้างได้เมื่อ login
      allow create: if isAuthenticated() &&
                    request.resource.data.userId == request.auth.uid;

      // แก้ไข/ลบ ไม่ได้ (immutable for legal compliance)
      allow update, delete: if false;
    }

    // ============================================
    // Bot Chats Collection
    // - เข้ารหัส AES-256
    // ============================================
    match /botChats/{chatId} {
      // อ่าน/เขียน ได้เฉพาะเจ้าของ
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() &&
                    request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================
    // Bot Configs Collection
    // ============================================
    match /botConfigs/{botId} {
      // อ่านได้ทุกคน
      allow read: if true;

      // เขียนได้เฉพาะ admin (ผ่าน Admin SDK)
      allow create, update, delete: if false;
    }

    // ============================================
    // User Bot Preferences Collection
    // ============================================
    match /userBotPreferences/{prefId} {
      // อ่านได้ทุกคน
      allow read: if true;

      // เขียนได้ทุกคน (รวม anonymous users)
      allow create, update: if true;
      allow delete: if false;
    }

    // ============================================
    // Subscriptions Collection
    // - จัดการผ่าน Stripe webhook + Admin SDK
    // ============================================
    match /subscriptions/{subId} {
      // อ่านได้เฉพาะเจ้าของ
      allow read: if isOwner(resource.data.userId);

      // เขียนผ่าน Admin SDK เท่านั้น
      allow create, update, delete: if false;
    }

    // ============================================
    // Reports Collection
    // ============================================
    match /reports/{reportId} {
      // อ่านไม่ได้จาก client (admin ใช้ Admin SDK)
      allow read: if false;

      // สร้างได้เมื่อ login
      allow create: if isAuthenticated() &&
                    request.resource.data.reporterId == request.auth.uid;

      // แก้ไข/ลบ ผ่าน Admin SDK เท่านั้น
      allow update, delete: if false;
    }

    // ============================================
    // Page Views Collection (Analytics)
    // ============================================
    match /pageviews/{viewId} {
      // อ่านไม่ได้จาก client
      allow read: if false;

      // สร้างได้ทุกคน (track pageview)
      allow create: if true;

      // แก้ไข/ลบ ไม่ได้
      allow update, delete: if false;
    }

    // ============================================
    // Articles Collection
    // ============================================
    match /articles/{articleId} {
      // อ่านได้ถ้า published
      allow read: if resource.data.isPublished == true;

      // เขียนผ่าน Admin SDK เท่านั้น
      allow create, update, delete: if false;
    }

    // ============================================
    // About Collection
    // ============================================
    match /about/{aboutId} {
      // อ่านได้ถ้า published
      allow read: if resource.data.isPublished == true;

      // เขียนผ่าน Admin SDK เท่านั้น
      allow create, update, delete: if false;
    }

    // ============================================
    // Admin Collections (Admin SDK only)
    // ============================================
    match /adminLogs/{logId} {
      allow read, write: if false;
    }

    match /analytics/{docId} {
      allow read, write: if false;
    }
  }
}
